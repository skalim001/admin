<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XinPay Admin Panel</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin:0; padding:0; }
  #loginForm, #menu, .panel { max-width: 1200px; margin: 40px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
  h2 { color: #4a3aff; margin-bottom: 20px; }
  input[type=password], input[type=text] { padding:10px; width:300px; font-size:16px; border-radius:5px; border:1px solid #ccc; margin-right:10px; }
  button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-size:16px; transition:0.2s; }
  button:hover { opacity:0.9; }
  #menu button { background-color:#4a3aff; color:white; margin:5px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
  th { background-color: #4a3aff; color: white; }
  tr:nth-child(even) { background-color: #f9f9f9; }
  tr:hover { background-color: #e8e8ff; }
  .approve-btn { background-color:#4CAF50; color:white; margin:2px; padding:6px 12px; border-radius:5px; cursor:pointer; }
  .reject-btn { background-color:#f44336; color:white; margin:2px; padding:6px 12px; border-radius:5px; cursor:pointer; }
  .save-btn { background-color:#039BE5; color:white; margin:2px; padding:6px 12px; border-radius:5px; cursor:pointer; }
  a { color:#4a3aff; text-decoration:none; }
  a:hover { text-decoration:underline; }
  #bankForm input { width: 100%; margin:5px 0; padding:8px; }
</style>
</head>
<body>

<!-- Login -->
<div id="loginForm">
  <h2>Admin Login</h2>
  <input type="password" id="adminPassword" placeholder="Enter password">
  <button onclick="login()">Login</button>
</div>

<!-- Menu -->
<div id="menu" style="display:none;">
  <h2>Admin Panel</h2>
  <button onclick="loadTable('inrDeposits')">INR Deposits</button>
  <button onclick="loadTable('usdtDeposits')">USDT Deposits</button>
  <button onclick="loadTable('inrWithdraws')">INR Withdraws</button>
  <button onclick="loadTable('usdtWithdraws')">USDT Withdraws</button>
  <button onclick="loadBankDetails()">Bank Details</button>
  <button onclick="loadTable('trc20Wallet')">TRC20 Wallet Address</button>
</div>

<!-- Table -->
<div class="panel" id="tableSection" style="display:none;">
  <h2 id="tableTitle"></h2>
  <table id="adminTable">
    <thead><tr id="tableHeader"></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Bank Form -->
<div class="panel" id="bankFormPanel" style="display:none;">
  <h2>Update Bank Details</h2>
  <form id="bankForm">
    <input type="text" id="accountNumber" placeholder="Account Number" required>
    <input type="text" id="ifscCode" placeholder="IFSC Code" required>
    <input type="text" id="accountHolder" placeholder="Account Holder Name" required>
    <input type="text" id="qrImageUrl" placeholder="QR Image URL">
    <button type="submit" class="save-btn">Save</button>
  </form>
  <p id="statusMsg" style="margin-top:10px;"></p>
</div>

<script>
const PASSWORD = "Admin123";
const keyMap = {
  "ID": "id", "User ID": "userId", "Amount": "amount", "Status": "status",
  "Type": "type", "Screenshot": "screenshotUrl", "Account No.": "accountNumber",
  "IFSC": "ifscCode", "Requested At": "requestedAt", "Wallet Address": "walletAddress"
};

// Login
function login() {
  const input = document.getElementById("adminPassword").value;
  if(input === PASSWORD) {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("menu").style.display = "block";
  } else { alert("Incorrect password"); }
}

function getApiBase(section){
  switch(section){
    case 'inrDeposits': return "https://xinpay.onrender.com/api/admin/inr-deposits";
    case 'usdtDeposits': return "https://xinpay.onrender.com/api/admin/usdt-deposits";
    case 'inrWithdraws': return "https://xinpay.onrender.com/api/admin/inr-withdraw";
    case 'usdtWithdraws': return "https://xinpay.onrender.com/api/admin/usdt-withdraw";
    case 'bankDetails': return "https://xinpay.onrender.com/api/admin/bank-details";
  }
}

// Load table for deposits/withdraws/wallet
function loadTable(section) {
  document.getElementById("bankFormPanel").style.display="none";
  const title = document.getElementById("tableTitle");
  const thead = document.getElementById("tableHeader");
  const tbody = document.querySelector("#adminTable tbody");
  document.getElementById("tableSection").style.display = "block";
  tbody.innerHTML = "";

  let columns = [];
  switch(section){
    case 'inrDeposits': title.innerText="Pending INR Deposits"; columns=["ID","User ID","Amount","Status","Type","Screenshot","Action"]; break;
    case 'usdtDeposits': title.innerText="Pending USDT Deposits"; columns=["ID","User ID","Amount","Status","Type","Screenshot","Action"]; break;
    case 'inrWithdraws': title.innerText="Pending INR Withdrawals"; columns=["ID","User ID","Amount","Account No.","IFSC","Requested At","Action"]; break;
    case 'usdtWithdraws': title.innerText="Pending USDT Withdrawals"; columns=["ID","User ID","Amount","Wallet Address","Requested At","Action"]; break;
    case 'trc20Wallet': title.innerText="Update TRC20 Wallet Address"; columns=["Current Address","New Address","Action"]; break;
  }

  // table headers
  thead.innerHTML = "";
  columns.forEach(col=>{
    const th = document.createElement("th");
    th.innerText = col;
    thead.appendChild(th);
  });

  // fetch data
  if(section === 'trc20Wallet'){
    fetch(getApiBase('trc20Wallet'))
      .then(res=>res.text())
      .then(addr=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${addr}</td>
                      <td><input type="text" id="newTrc20Address" placeholder="Enter new TRC20 address"></td>
                      <td><button onclick="updateTrc20()" class="save-btn">Update</button></td>`;
        tbody.appendChild(tr);
      });
  } else {
    fetch(`${getApiBase(section)}/pending`)
      .then(res=>res.json())
      .then(data=>{
        data.forEach(d=>{
          const tr=document.createElement("tr");
          columns.forEach(col=>{
            const td=document.createElement("td");
            if(col==="Action"){
              td.innerHTML=`<button class="approve-btn" onclick="approve('${section}',${d.id})">✅</button>
                            <button class="reject-btn" onclick="reject('${section}',${d.id})">✖</button>`;
            } else if(col==="Screenshot" && d.screenshotUrl){
              td.innerHTML=`<a href="${d.screenshotUrl}" target="_blank">View</a>`;
            } else {
              const key = keyMap[col];
              td.innerText = (key==="amount") ? (section.toLowerCase().includes("usdt") ? `$${d[key]}` : `₹${d[key]}`) : d[key] || '';
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      })
      .catch(err=>{ console.error(err); alert("Failed to fetch data"); });
  }
}

// Approve/Reject
function approve(section,id){ fetch(`${getApiBase(section)}/${id}/approve`,{method:"PUT"}).then(res=>res.ok?loadTable(section):alert("Failed to approve")); }
function reject(section,id){ fetch(`${getApiBase(section)}/${id}/reject`,{method:"PUT"}).then(res=>res.ok?loadTable(section):alert("Failed to reject")); }

// --- BANK DETAILS ---
function loadBankDetails() {
  document.getElementById("tableSection").style.display="none";
  document.getElementById("bankFormPanel").style.display="block";
  const statusMsg = document.getElementById("statusMsg");
  statusMsg.innerText="Loading...";
  fetch(getApiBase("bankDetails"))
    .then(res=>{
      if(!res.ok) throw new Error("Failed to fetch bank details");
      return res.json();
    })
    .then(data=>{
      document.getElementById("accountNumber").value = data.accountNumber || '';
      document.getElementById("ifscCode").value = data.ifscCode || '';
      document.getElementById("accountHolder").value = data.accountHolder || '';
      document.getElementById("qrImageUrl").value = data.qrUrl || '';
      statusMsg.innerText="";
    })
    .catch(err=>{
      console.error(err);
      statusMsg.innerText="❌ Failed to fetch bank details";
    });
}

// Save bank details
document.getElementById("bankForm").addEventListener("submit", async function(e){
  e.preventDefault();
  const statusMsg = document.getElementById("statusMsg");
  const form = {
    accountNumber: document.getElementById("accountNumber").value.trim(),
    ifscCode: document.getElementById("ifscCode").value.trim(),
    accountHolder: document.getElementById("accountHolder").value.trim(),
    qrUrl: document.getElementById("qrImageUrl").value.trim()
  };
  statusMsg.innerText="Saving...";
  try{
    const res = await fetch(getApiBase("bankDetails")+"/update",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(form)
    });
    statusMsg.innerText = res.ok ? "✅ Bank details updated!" : "❌ Failed to save.";
  } catch(err){
    console.error(err);
    statusMsg.innerText="❌ Error occurred";
  }
});
</script>

</body>
</html>
